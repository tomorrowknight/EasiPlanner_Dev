function tsptw(b,a,c,d){var h=[];b=createDepotParcel(b);a.reduce(function(a,b){return a+b.get("volume")},0);a.reduce(function(a,b){return a+b.get("weight")},0);a.each(function(a){a.set("planned_deliver_time",null);a.set("visited",null)});for(a=a.reject(function(a){for(var b in c)if(a.fitTo(c[b]))return!1;return!0});0<a.length;){var e=c.shift();c.push(e);e.left_volume=e.get("capacity_volume");e.left_weight=e.get("capacity_weight");var g=[];g.push(b);for(g.push(b);;){var k=!1;if(null==d)var l=getCenter(g,
b,a),f=_.sortBy(a,function(a){return a.distance(l)});else f=_.sortBy(a,function(a){return a.distance(d)});f=_.reject(f,function(a){return!a.fitTo(e)});f=f.slice(0,10);_.each(f,function(b){if(!(e.left_volume<b.get("volume")||e.left_weight<b.get("weight")))for(var c=calIndexsBySavings(b,g),d=0;d<c.length;d++){var h=c[d],f=_.map(g,function(a){return a.clone()});if(insertParcel(f,h,b.clone())){insertParcel(g,h,b);b.set("visited",!0);a.remove(b);e.left_volume-=b.get("volume");e.left_weight-=b.get("weight");
k=!0;break}}});if(!k)break}g.pop();g.shift();f={vehicle:e,parcels:g,id:(new Date).getTime()};if(null!=d)return f;h.push(f)}printRoutes(h);return h}Array.prototype.remove=function(b){b=this.indexOf(b);-1<b&&this.splice(b,1);return this};
function getCenter(b,a,c){if(2==b.length)return _.max(c,function(b){return b.get("visited")?0:b.distance(a)});b.pop();b.shift();c=_.reduce(b,function(a,b){return{lat:a.lat+b.get("lat"),lng:a.lng+b.get("lng")}},{lat:0,lng:0});var d=new Parcel;d.set("lat",c.lat/b.length);d.set("lng",c.lng/b.length);b.unshift(a);b.push(a);return d}function printRoutes(b){}
function calIndexsBySavings(b,a){for(var c=[],d=0;d<a.length-1;d++)c.push({index:d,saving:matrix.travelTime(b,a[d],a[d].getWindowStart())+matrix.travelTime(b,a[d+1],a[d+1].getWindowStart())-matrix.travelTime(a[d],a[d+1],a[d+1].getWindowStart())});c=_.sortBy(c,function(a){return a.saving});return _.map(c,function(a){return a.index})}
function insertParcel(b,a,c){b.splice(a+1,0,c);for(a+=1;a<b.length-1;a++){c=Math.max(b[a-1].getServiceEndTime()+matrix.travelTime(b[a-1],b[a],b[a].getWindowStart()),b[a].getWindowStartTime());if(c==b[a].get("planned_deliver_time"))break;else if(c>b[a].getLatestStartTime())return!1;b[a].set("planned_deliver_time",c)}return!0}
function createDepotParcel(b){var a=new Parcel;a.set("window_start","2000-01-01");a.set("window_end","2099-01-01");a.set("lat",b.get("lat"));a.set("lng",b.get("lng"));a.set("i",0);a.set("postal",b.get("postal"));a.set("service_time",0);a.set("planned_deliver_time",a.getWindowStartTime());return a};